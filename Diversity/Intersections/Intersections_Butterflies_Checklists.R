####################################################################################################
### Intersections between Butterflies and bioregions
### Charlie Marsh
### Checklists generated by David Lohman and Peggie Djunijanti.
### Does not include data for Ryukus or Guangxi
### charliem2003@github
### 07/2024
###
### Regions map used: Bioregions_checklists
### Taxonomy used:    Personal updates to Lamas, G. (2015) Catalog of the butterflies (Papilionoidea)
### Checklist used:   David Lohman and Peggie Djunijanti
### Endemism determined from: Pinkert, Stefan, Vijay Barve, Robert Guralnick, and Walter Jetz. 2022.
###   Global Geographical and Latitudinal Variation in Butterfly Species Richness Captured through
###   a Comprehensive Country-Level Occurrence Database.” Global Ecology and Biogeography 31(5): 830–39.
###   https://doi.org/10.1111/geb.13475.
### Pinkert, Stefan; Barve, Vijay; Guralnick, Rob; Jetz, Walter (2022), Data for: Global geographic
###   and latitudinal variation in butterfly species richness captured through a comprehensive country-level
###   occurrence database, Dryad, Dataset, https://doi.org/10.5061/dryad.cz8w9gj47
###
### CITATION:
###   ?
###
### saves csv with the presence-absence of each species within each bioregion
####################################################################################################

#==================================================================================================#
#--------------------------------------------- Set-up ---------------------------------------------#
#==================================================================================================#

rm(list = ls())

### Libraries
library(readxl)
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(sf)
library(terra)

### Locations of data, scripts and results
baseDir    <- "/mnt/Work"
spatialDir <- file.path(baseDir, "spatial_data", "biodiversity")       # dir that contains spatial data
regionDir  <- file.path(baseDir, "NUS", "BTAS_data")                   # dir that contains the regions data
dataDir    <- file.path(spatialDir, "checklists", "butterflies")       # dir that contains the checklist data
resDir     <- file.path(baseDir, "NUS", "BTAS", "Intersections")       # dir to save results to
funDir     <- file.path(baseDir, "NUS", "BTAS", "Analysis_functions")  # dir that contains the function scripts

sdmDir <- file.path(spatialDir, "sdms", "butterflies", "Yu")
occDir <- file.path(spatialDir, "occurrence_points", "butterflies", "Yu")

### Function for cleaning dates and extracting region info from inside brackets
source(file.path(funDir, "Discovery_rates", "clean_publication_dates.R"))

#==================================================================================================#
#------------------------------------------- Data prep --------------------------------------------#
#==================================================================================================#

### Data for each region is stored in individual sheets in an xlsx file
filePath <- file.path(dataDir, "Lohman", "Asian_Butterfly_Distributions_20240702.xlsx")

### Read in and append individual data sheets - 4,757 species
all <- bind_rows(data.frame(Bioregion = "Indian_Subcontinent", read_xlsx(filePath, "SouthAsia_List")),
                 data.frame(Bioregion = "IndoChina",           read_xlsx(filePath, "Continental_SEAsia_List")),
                 data.frame(Bioregion = "Andamans",            read_xlsx(filePath, "AndamansNicobars_List")),
                 data.frame(Bioregion = "Malaya",              read_xlsx(filePath, "MalayPeninsula_List")),
                 data.frame(Bioregion = "Borneo",              read_xlsx(filePath, "Borneo_List")),
                 data.frame(Bioregion = "Palawan",             read_xlsx(filePath, "PalawanArea_List")),
                 data.frame(Bioregion = "Philippines",         read_xlsx(filePath, "PhilippinesNotPalawan_List")),
                 data.frame(Bioregion = "Sumatra",             read_xlsx(filePath, "Sumatra_Region_List")),
                 data.frame(Bioregion = "Java",                read_xlsx(filePath, "Java+Bali_List")),
                 data.frame(Bioregion = "Lesser_Sundas",       read_xlsx(filePath, "LesserSundas_List")),
                 data.frame(Bioregion = "Sulawesi",            read_xlsx(filePath, "Sulawesi_List")),
                 data.frame(Bioregion = "Maluku",              read_xlsx(filePath, "Maluku+NorthMaluku_List")),
                 data.frame(Bioregion = "New_Guinea",          read_xlsx(filePath, "New_Guinea_LIst"))) %>%
  as_tibble() %>%
  mutate(Species = gsub(" ", "_", Binomial_accepted)) %>%
  mutate(Year = clean_publication_dates(Species_authority, max = TRUE, first = FALSE)) %>%
  select(Species, Year, Bioregion) %>%
  distinct()

### Some manual cleaning of description dates 
all$Year[all$Species == "Bletogona_mycalesis"]    <- 1867
all$Year[all$Species == "Thermozephyrus_kubotae"] <- 2014
all$Year[all$Species == "Papilio_castor"]         <- 1842

### Global species list - 19,389 species
global <- read_excel(filePath, sheet = "GLOBAL_BUTTERFLY_LIST") %>%
  mutate(Species = gsub(" ", "_", Binomial_accepted)) %>%
  mutate(Genus = sapply(Binomial_accepted, function(x) unlist(strsplit(x, " ")[[1]][1]))) %>%
  select(Species, Genus, Family) %>%
  distinct()

### Data from Pinkert et al 2022 for determining endemism
pinkert <- read_csv(file.path(dataDir, "Pinkert_MOL", "BttflyCCL_long_format_20220401.csv")) %>%
  distinct() %>%
  mutate(Species = gsub(" ", "_", ValidBinomial))

### GADM codes for converting Pinkert Alpha3 codes to countries
gadm_codes <- read.csv(file.path(dataDir, "Pinkert_MOL/gadm_codes.csv"))

### global GADM for masking out coastlines in SDM outputs
gadm <- st_read(file.path(regionDir, "countries", "GADM_410_land_Equal_Area.gpkg"))

### Regions data
regions <- st_read(file.path(regionDir, "Bioregions", "Bioregions_checklists_noJapan.gpkg"))

#==================================================================================================#
#------------------------------------ Determine intersections -------------------------------------#
#==================================================================================================#

### Merge with taxonomy from global species list
all <- all %>%
  left_join(global,
            by = "Species")

### Pivot to wide format
all <- all %>%
  mutate(Presence = 1) %>%
  pivot_wider(id_cols     = c(Species, Genus, Family, Year),
              names_from  = Bioregion,
              values_from = Presence,
              values_fill = 0)

#==================================================================================================#
#-------------------------------- Determine tropical Asia endemism --------------------------------#
#==================================================================================================#

### First use the Pinkert data set. Keep only matching species and convert alpha3 codes to gadm names
pinkert <- pinkert %>%
  filter(Species %in% all$Species) %>%
  left_join(gadm_codes, join_by(Alpha.3 == GID_0))

### There is now a column defining whether each country is inside (1) or outside (0) tropical asia
### Summarise whether each species has any country information outside tropical asia
pinkert <- pinkert %>%
  reframe(AsiaEndemic   = min(TROPICAL_ASIA),
          COUNTRY       = unique(COUNTRY),
          .by           = Species)

### Pivot to species x country data frame. Remove columns for countries inside tropical Asia
pinkert <- pinkert %>%
  mutate(presence = 1) %>%
  pivot_wider(id_cols     = c(Species, AsiaEndemic),
              names_from  = COUNTRY,
              values_from = presence) %>%
  select(Species, AsiaEndemic, any_of(gadm_codes$COUNTRY[gadm_codes$TROPICAL_ASIA == 0]))

### Some species have only 'China' potential non-endemic info. Subset these species out
chinaOnly <- pinkert %>%
  mutate(n = rowSums(select(pinkert, -Species, -AsiaEndemic), na.rm = TRUE)) %>%
  filter(China == 1 & n == 1) %>%
  select(Species, AsiaEndemic, China, n)

### Otherwise keep other sets
pinkert <- pinkert %>%
  mutate(n = rowSums(select(pinkert, -Species, -AsiaEndemic), na.rm = TRUE)) %>%
  filter(!Species %in% chinaOnly$Species) %>%
  select(Species, AsiaEndemic, n)

#####################################################################
### Second, for china-only species try SDM outputs from Yu et al 2024

spList <- list.files(sdmDir, pattern = ".tif", full.names = FALSE)
spList <- sapply(spList, function(x) paste(strsplit(x, "[._]")[[1]][1:2], collapse = "_"))
spList <- spList[spList %in% chinaOnly$Species]

endemic <- data.frame(matrix(NA, ncol = nrow(regions) + 3))
names(endemic) <- c("Species", regions$Bioregion, "Total", "All_pts")
pb <- txtProgressBar(1, length(spList), style = 3)
for(i in 1:length(spList)) {
  setTxtProgressBar(pb, i)
  sp <- spList[i]

  ### read in species raster and convert to cell centroids
  spMap <- rast(file.path(sdmDir, paste0(gsub("_", ".", sp), "_ensemble_TSSbin.tif")))
  spMap <- as.points(spMap, values = TRUE) %>%
    st_as_sf() %>%
    rename(presence = paste0(gsub("_", ".", sp), "_EMmeanByTSS_mergedData_mergedRun_mergedAlgo")) %>%
    select(presence) %>%
    filter(presence == 1) %>%
    st_transform(st_crs(regions))

  ### Mask to GDM
  land <- st_intersects(spMap, gadm, sparse = FALSE)
  spMap <- spMap[land == TRUE, ]

  ### Intersect with bioregions
  intersection   <- as.data.frame(st_intersects(spMap, regions, sparse = FALSE))
  names(intersection) <- regions$Bioregion

  endemic[i,  1] <- sp
  endemic[i, -1] <- as.numeric(c(colSums(intersection), sum(intersection), nrow(spMap)))
}
endemic$Prop <- endemic$Total / endemic$All_pts

### For species without SDMs use points instead
occs <- read_csv(file.path(occDir, "OccurrenceRecords_22Jan2024_EY.csv")) %>%
  select(final_genus_species, lohman_final_genus_species, decimalLongitude, decimalLatitude) %>%
  mutate(Species_final  = gsub(" ", "_", final_genus_species)) %>%
  mutate(Species_lohman = gsub(" ", "_", lohman_final_genus_species)) %>%
  mutate(which_species = NA) %>%
  filter((Species_lohman %in% chinaOnly$Species) | (Species_final %in% chinaOnly$Species))

### There are two potential names to choose from. Try 'Lohman' first, then 'final'
occs$which_species[occs$Species_final  %in% chinaOnly$Species] <- "final"
occs$which_species[occs$Species_lohman %in% chinaOnly$Species] <- "lohman"
occs <- occs %>%
  mutate(Species = case_when(which_species == "lohman" ~ Species_lohman,
                             which_species == "final"  ~ Species_final))

### Loop through full species list
SpList <- unique(occs$Species)
pts <- data.frame(matrix(NA, ncol = nrow(regions) + 3))
names(pts) <- c("Species", regions$Bioregion, "Total", "All_pts")
pb <- txtProgressBar(1, length(spList), style = 3)
for(i in 1:length(spList)) {
  setTxtProgressBar(pb, i)
  sp <- spList[i]

  ### filter species points
  spPts <- filter(occs, Species == sp)
  spPts <- st_as_sf(spPts, coords = c("decimalLongitude", "decimalLatitude"), crs = st_crs(4326)) %>%
    st_transform(st_crs(regions))

  ### Mask to GDM
  land <- st_intersects(spPts, gadm, sparse = FALSE)
  spPts <- spPts[land == TRUE, ]

  if(nrow(spPts) > 0) {
    ### Intersect with bioregions
    intersection   <- as.data.frame(st_intersects(spPts, regions, sparse = FALSE))
    names(intersection) <- regions$Bioregion

    pts[i,  1] <- sp
    pts[i, -1] <- as.numeric(c(colSums(intersection), sum(intersection), nrow(spPts)))
  }
}
pts$Prop <- pts$Total / pts$All_pts

### Apply a 95% threshold to account for overprediction and data errors
sdm <- sdm %>%
  mutate(endemic = case_when(Prop >= 0.95 ~ 1,
                             Prop <  0.95 ~ 0)) %>%
  mutate(type = "sdm")

pts <- pts %>%
  mutate(endemic = case_when(Prop >= 0.95 ~ 1,
                             Prop <  0.95 ~ 0)) %>%
  mutate(type = "pts")

### The points and SDMs largely agree with each other in terms of endemism
inner_join(pts, sdm, by = "Species", suffix = c("_pts", "_sdm")) %>%
  filter(endemic_pts != endemic_sdm) %>%
  select(Species) %>%
  as.vector()

### There are species with points without sdms, and vice-versa, so we need both sets
length(pts$Species[ pts$Species %in% sdm$Species])
length(sdm$Species[!sdm$Species %in% pts$Species])
length(pts$Species[!pts$Species %in% sdm$Species])

### Where there are both then default to the SDM prediction
both <- bind_rows(sdm, pts[!pts$Species %in% sdm$Species, ]) %>%
  rename(AsiaEndemic = endemic)
chinaOnly <- left_join(select(chinaOnly, Species),
                       select(both, Species, AsiaEndemic), by = "Species")

###########################################################################
### Third, for china only species without points or sdms use expert opinion

### There are 223 species remaining without points or sdms
sum(is.na(chinaOnly$AsiaEndemic))

### In these cases, use the expert opinion of David Lohman
manual <- read.csv(file.path(dataDir, "Lohman", "chinaOnly_species_DL.csv")) %>%
  mutate(Species = gsub(" ", "_", Species)) %>%
  mutate(AsiaEndemic = case_when(AsiaEndemic == "No"  ~ 0,
                                 AsiaEndemic == "Yes" ~ 1,
                                 AsiaEndemic == "Yes Asian Endemic; not found in China" ~ 1,
                                 AsiaEndemic == "Yes Asian Endemic; probably not found in China" ~ 1)) %>%
  select(Species, AsiaEndemic)

### Join the manual species up with the other China only species
chinaOnly <- left_join(chinaOnly, manual, by = "Species") %>%
  mutate(AsiaEndemic = rowSums(.[, c("AsiaEndemic.x", "AsiaEndemic.y")], na.rm = TRUE)) %>%
  select(Species, AsiaEndemic)

########################################################################################
### Fourth, finally for 178 species missing from Pinkert and Yu, also use expert opinion

missing <- read.csv(file.path(dataDir, "Lohman", "missing_Pinkert_species_DL.csv")) %>%
  filter(AsiaEndemic == "Unknown_missing_Pinkert") %>%
  mutate(Species = gsub(" ", "_", Species)) %>%
  mutate(AsiaEndemic = case_when(Asian.Endemic. == "No"  ~ 0,
                                 Asian.Endemic. == "Yes" ~ 1)) %>%
  select(Species, AsiaEndemic)

### And join everything back up with the pinkert data
endemism <- bind_rows(pinkert, chinaOnly, missing) %>%
  select(Species, AsiaEndemic)

################################################################
### Add the pinkert and china only data to the overall data frame

all <- all %>%
  left_join(endemism) %>%
  relocate(AsiaEndemic, .after = Year)

### total number of species native to region and number of species endemic to tropical asia
table(all$AsiaEndemic, useNA = "always")

### save results
write.csv(all, file.path(resDir, "Intersections", "Intersections_bioregions_butterflies.csv"),
          quote = FALSE, row.names = FALSE)

####################################################################################################
### plot richness and turnover

all <- read.csv(file.path(resDir, "Intersections", "Intersections_bioregions_butterflies.csv"))
regions <- st_read(file.path(regionDir, "Bioregions", "Bioregions_checklists_noJapan.gpkg")) %>%
  st_simplify(dTolerance = 1000)

rich <- data.frame(Bioregion = names(all[, -c(1:5)]),
                   Rich = colSums(all[, -c(1:5)]))
rich <- left_join(regions, rich, by = "Bioregion")

ggplot() + 
  theme(axis.ticks = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_rect(colour = "black", fill = NA),
        # legend.position = c(0.1, 0.02),
        legend.position = "bottom",
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 7),
        legend.justification = c("left", "bottom"),
        legend.key = element_blank()) +
  scale_fill_viridis_c(option = "C", name = NULL, trans = "log10") +
  guides(size = guide_legend(nrow = 2)) +
  scale_radius(range = c(3, 8),
               breaks = round(10 ^ seq(log10(min(rich$Rich)), log10(max(rich$Rich)), length.out = 5), 0),
               name = "Species Richness",
               trans = "log10") +
  geom_sf(data = rich, aes(fill = Rich)) + 
  geom_sf(data = st_centroid(rich),
          col = "black", pch = 21, aes(size = Rich, fill = Rich))

